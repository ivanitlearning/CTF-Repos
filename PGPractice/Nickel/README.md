# Almost Priv Esc

This isn't actually priv esc but just something interesting I learned while reading about OpenSSH on Windows. The config file is in **C:\ProgramData\ssh\sshd_config**

```text
# This is the sshd server system-wide configuration file.  See
# sshd_config(5) for more information.

# The strategy used for options in the default sshd_config shipped with
# OpenSSH is to specify options with their default value where
# possible, but leave them commented.  Uncommented options override the
# default value.

Port 22
#AddressFamily any
ListenAddress 0.0.0.0
#ListenAddress ::

#HostKey __PROGRAMDATA__/ssh/ssh_host_rsa_key
#HostKey __PROGRAMDATA__/ssh/ssh_host_dsa_key
#HostKey __PROGRAMDATA__/ssh/ssh_host_ecdsa_key
#HostKey __PROGRAMDATA__/ssh/ssh_host_ed25519_key

# Ciphers and keying
#RekeyLimit default none

# Logging
#SyslogFacility AUTH
#LogLevel INFO

# Authentication:

#LoginGraceTime 2m
#PermitRootLogin prohibit-password
#StrictModes yes
#MaxAuthTries 6
#MaxSessions 10

#PubkeyAuthentication yes

# The default is to check both .ssh/authorized_keys and .ssh/authorized_keys2
# but this is overridden so installations will only check .ssh/authorized_keys
AuthorizedKeysFile      .ssh/authorized_keys

#AuthorizedPrincipalsFile none

# For this to work you will also need host keys in %programData%/ssh/ssh_known_hosts
#HostbasedAuthentication no
# Change to yes if you don't trust ~/.ssh/known_hosts for
# HostbasedAuthentication
#IgnoreUserKnownHosts no
# Don't read the user's ~/.rhosts and ~/.shosts files
#IgnoreRhosts yes

# To disable tunneled clear text passwords, change to no here!
#PasswordAuthentication yes
#PermitEmptyPasswords no

#AllowAgentForwarding yes
#AllowTcpForwarding yes
#GatewayPorts no
#PermitTTY yes
#PrintMotd yes
#PrintLastLog yes
#TCPKeepAlive yes
#UseLogin no
#PermitUserEnvironment no
#ClientAliveInterval 0
#ClientAliveCountMax 3
#UseDNS no
#PidFile /var/run/sshd.pid
#MaxStartups 10:30:100
#PermitTunnel no
#ChrootDirectory none
#VersionAddendum none

# no default banner path
#Banner none

# override default of no subsystems
Subsystem       sftp    sftp-server.exe

# Example of overriding settings on a per-user basis
Match User Administrator
#       AllowTcpForwarding no
#       PermitTTY no
        ForceCommand C:\foo.exe
        ChrootDirectory C:\foo

Match Group administrators
       AuthorizedKeysFile __PROGRAMDATA__/ssh/administrators_authorized_keys
```

Note the last two paras of settings. It says the authorized_keys for administrators must be **C:\ProgramData\ssh\administrators_authorized_keys** and not the Users dir for Administrator. If we have SYSTEM file write, which we do with Mozilla FTP server, then we can write it there. 

However this fails because we need one thing which is absent here `StrictModes no`. The full criteria for the upload pubkey priv esc is [listed here](https://decoder.cloud/2020/03/19/the-strange-case-of-open-ssh-in-windows-server-2019/)

1. “*StrictModes*” set to “no” will bypass the owner/permissions strict checks on the “authorized_keys file”
2. “*PubkeyAuthentication*” set to yes will permit login via public/private keys
3. “*Match Group administrators*” will point to an “authorized”_keys” file generated by the user

StrictModes by default is set to yes, and its absence here means we have to [do this](https://superuser.com/a/1605117/1003382) to make the OpenSSH server accept the uploaded public key. 

```powershell
$acl = Get-Acl C:\ProgramData\ssh\administrators_authorized_keys
$acl.SetAccessRuleProtection($true, $false)
$administratorsRule = New-Object system.security.accesscontrol.filesystemaccessrule("Administrators","FullControl","Allow")
$systemRule = New-Object system.security.accesscontrol.filesystemaccessrule("SYSTEM","FullControl","Allow")
$acl.SetAccessRule($administratorsRule)
$acl.SetAccessRule($systemRule)
$acl | Set-Acl
```

This we can't do on this box unfortunately, since using FTP to upload files from Linux doesn't let us set its permissions. In addition because of the config of this box, we also see

```text
	ForceCommand C:\foo.exe
    ChrootDirectory C:\foo
```

which basically means that any successful login with the private key would cause C:\foo.exe to be executed and the directory to be confined to C:\foo. Neither of this exist, but we can create C:\foo and upload a reverse shell exe as C:\foo.exe. If we could set the ACL for authorized_keys this works.